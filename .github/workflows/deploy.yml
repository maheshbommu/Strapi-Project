name: Deploy Strapi CMS to AWS

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ap-south-1
  ECR_REPO_NAME: strapi-app
  ECS_CLUSTER: strapi-cluster
  ECS_SERVICE: strapi-service

jobs:
  build:
    name: Build Strapi & Push Docker Image
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Install dependencies
      run: npm install
      working-directory: ./app

    - name: Build Strapi project
      run: npm run build
      working-directory: ./app

    - name: Run tests (optional)
      run: npm test || true
      working-directory: ./app


    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create ECR repository if not exists
      run: |
        aws ecr describe-repositories --repository-names $ECR_REPO_NAME || \
        aws ecr create-repository --repository-name $ECR_REPO_NAME

        # -------------------------
        # 7. Get ECR URI
        # -------------------------
    - name: Get ECR URI
      run: |
        ECR_URI=$(aws ecr describe-repositories --repository-names $ECR_REPO_NAME --query "repositories[0].repositoryUri" --output text)
        echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

        # -------------------------
        # 8. Login to ECR
        # -------------------------
    - name: Login to Amazon ECR
      run: |
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI

        # -------------------------
        # 9. Build Docker Image (from /app)
        # -------------------------
    - name: Build Docker image
      run: |
        docker build -t $ECR_URI:latest -f ./app/Dockerfile ./app


    # -------------------------
    # 10. Push Image to ECR
    # -------------------------
    - name: Push Docker image
      run: |
        docker push $ECR_URI:latest    

    - name: Build & Push Docker image to ECR
      run: |
        ECR_URI=$(aws ecr describe-repositories --repository-names $ECR_REPO_NAME --query "repositories[0].repositoryUri" --output text)
        docker build -t $ECR_URI:latest .
        docker push $ECR_URI:latest

    - name: Save ECR URI
      id: ecr
      run: |
        echo "uri=$(aws ecr describe-repositories --repository-names $ECR_REPO_NAME --query "repositories[0].repositoryUri" --output text)" >> $GITHUB_OUTPUT


  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -out plan.tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve plan.tfplan


  deploy:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: terraform

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Update ECS service to use new image
      run: |
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --force-new-deployment
